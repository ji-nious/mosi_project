import{r as h,j as e,R as D,a as J}from"./client-D_PkVYew.js";import"./modulepreload-polyfill-B5Qt9EMX.js";const j=async s=>{if(s.status===401)return window.location.href="/login",null;try{return await s.json()}catch(a){throw console.error("JSON 파싱 오류:",a),new Error("서버 응답을 처리할 수 없습니다")}},g=(s,a)=>{throw console.error(`${a} 실패:`,s),s},O={async getOrderInfo(){try{const s=await fetch("/order/info",{method:"GET",headers:{"Content-Type":"application/json"}});return await j(s)}catch(s){g(s,"주문 정보 조회")}},async createOrder(s){try{const a=await fetch("/order/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return await j(a)}catch(a){g(a,"주문 생성")}},async processPayment(s){try{const a=await fetch("/order/payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(s)});return await j(a)}catch(a){g(a,"결제 처리")}},async getOrderDetail(s){try{const a=await fetch(`/order/${s}`,{method:"GET",headers:{"Content-Type":"application/json"}});return await j(a)}catch(a){g(a,"주문 상세 조회")}},async cancelOrder(s,a){try{const o=await fetch(`/order/${s}/cancel`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reason:a})});return await j(o)}catch(o){g(o,"주문 취소")}}};function b({label:s,placeholder:a,value:o,onChange:d,type:m="text",required:i=!1,disabled:p=!1}){return e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:s}),e.jsx("input",{type:m,placeholder:a,value:o,onChange:l=>d(l.target.value),required:i,disabled:p,className:"form-input"})]})}function I({name:s,value:a,checked:o,onChange:d,children:m}){return e.jsxs("div",{className:`payment-option ${o?"selected":""}`,onClick:()=>d(a),children:[e.jsx("input",{type:"radio",name:s,value:a,checked:o,onChange:()=>d(a),className:"payment-radio"}),e.jsx("div",{className:"payment-content",children:e.jsx("div",{className:"payment-label",children:m})})]})}function A({productName:s,price:a,quantity:o,optionType:d,sellerNickname:m,productImage:i,originalPrice:p}){return e.jsxs("div",{className:"order-item",children:[e.jsx("div",{className:"order-item-image",children:i?e.jsx("img",{src:i,alt:s,loading:"lazy",onError:l=>{l.target&&(l.target.style.display="none",l.target.nextSibling&&(l.target.nextSibling.style.display="block"))}}):e.jsx("div",{className:"no-image",children:"이미지 없음"})}),e.jsxs("div",{className:"order-item-info",children:[e.jsx("div",{className:"order-item-title",children:s}),e.jsxs("div",{className:"order-item-option",children:["옵션: (",d,")"]}),e.jsxs("div",{className:"order-item-seller",children:["판매자: ",m||"판매자"]})]}),e.jsxs("div",{className:"order-item-price",children:[p&&p!==a&&e.jsxs("span",{className:"original-price",children:[(p*o).toLocaleString(),"원"]}),e.jsxs("span",{className:"sale-price",children:[(a*o).toLocaleString(),"원"]})]})]})}function U({orderItems:s=[],memberInfo:a={},onSubmit:o,paymentMethod:d,onPaymentMethodChange:m}){const[i,p]=h.useState({ordererName:a.name||"",phone:a.phone||"",email:a.email||"",requirements:""}),l=(n,N)=>{p(f=>({...f,[n]:N}))},y=n=>{if(n.preventDefault(),!i.ordererName||!i.phone||!i.email){alert("필수 정보를 모두 입력해주세요.");return}if(!d){alert("결제수단을 선택해주세요.");return}o({...i,items:s})};return e.jsxs("form",{onSubmit:y,className:"order-form",children:[e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("i",{className:"fas fa-user section-icon"}),"주문자 정보"]}),e.jsx(b,{label:"주문자명",placeholder:"이름을 입력해주세요",value:i.ordererName,onChange:n=>l("ordererName",n),disabled:!!a.name}),e.jsx(b,{label:"연락처",placeholder:"휴대폰 번호를 입력해주세요",value:i.phone,onChange:n=>l("phone",n),disabled:!!a.phone}),e.jsx(b,{label:"이메일",type:"email",placeholder:"이메일 주소를 입력해주세요",value:i.email,onChange:n=>l("email",n),disabled:!!a.email}),e.jsxs("div",{className:"form-group",children:[e.jsx("label",{className:"form-label",children:"요청사항(50자 이내)"}),e.jsx("textarea",{placeholder:"요구사항을 입력해주세요",value:i.requirements,onChange:n=>l("requirements",n.target.value),className:"form-textarea",rows:"2",maxLength:50}),e.jsxs("div",{className:"character-counter",children:[e.jsxs("span",{className:i.requirements.length>50?"error":"",children:[i.requirements.length,"/50자"]}),i.requirements.length>50&&e.jsx("span",{className:"error-message",children:"50자를 초과했습니다."})]})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("i",{className:"fas fa-credit-card section-icon"}),"결제수단"]}),e.jsxs("div",{className:"payment-options",children:[e.jsx(I,{name:"payment",value:"card",checked:d==="card",onChange:n=>{m(n),window.processPaymentImmediately&&window.processPaymentImmediately(n)},children:"신용카드 / 체크카드"}),e.jsx(I,{name:"payment",value:"bank",checked:d==="bank",onChange:n=>{m(n),window.processPaymentImmediately&&window.processPaymentImmediately(n)},children:"무통장입금"}),e.jsx(I,{name:"payment",value:"simple",checked:d==="simple",onChange:n=>{m(n),window.processPaymentImmediately&&window.processPaymentImmediately(n)},children:"간편결제"})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("i",{className:"fas fa-shopping-bag section-icon"}),"주문상품(",s.length,"개)"]}),s.length>0?s.map((n,N)=>e.jsx(A,{productName:n.productName,price:n.price,quantity:n.quantity,optionType:n.optionType,sellerNickname:n.sellerNickname,productImage:n.productImage,originalPrice:n.originalPrice},N)):e.jsxs("div",{className:"no-items",children:[e.jsx("p",{children:"주문할 상품이 없습니다."}),e.jsx("a",{href:"/cart",className:"go-cart-btn",children:"장바구니로 이동"})]})]})]})}function B({items:s=[]}){s.length;const a=s.reduce((o,d)=>o+d.price*d.quantity,0);return e.jsxs("div",{className:"payment-summary",children:[e.jsx("div",{className:"payment-title",children:"결제정보"}),e.jsxs("div",{className:"order-summary-section",children:[e.jsx("div",{className:"summary-header",children:e.jsx("span",{children:"주문상품"})}),e.jsx("div",{className:"items-summary",children:s.map((o,d)=>e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"item-name",children:o.productName}),e.jsxs("span",{className:"item-price",children:[(o.price*o.quantity).toLocaleString(),"원"]})]},d))})]}),e.jsxs("div",{className:"payment-total",children:[e.jsx("span",{className:"payment-total-label",children:"총 상품 금액"}),e.jsxs("span",{className:"payment-total-price",children:[a?.toLocaleString(),"원"]})]})]})}function F({message:s,onRetry:a}){return e.jsxs("div",{className:"error-container",children:[e.jsx("div",{className:"error-icon",children:e.jsx("i",{className:"fas fa-exclamation-triangle"})}),e.jsx("h2",{children:"오류가 발생했습니다"}),e.jsx("p",{children:s}),e.jsx("button",{onClick:a,className:"payment-button",children:"다시 시도"})]})}function G(){const[s,a]=h.useState(null),[o,d]=h.useState({}),[m,i]=h.useState(null),[p,l]=h.useState(!1),[y,n]=h.useState(""),[N,f]=h.useState(!1),[T,v]=h.useState(!1),[q,k]=h.useState(!1),u=s?.orderItems||[],w=u.reduce((c,t)=>c+t.price*t.quantity,0);h.useEffect(()=>(S(),window.processPaymentImmediately=L,v(!0),()=>{delete window.processPaymentImmediately}),[]);const S=async()=>{try{i(null);const c=sessionStorage.getItem("selectedCartItems");if(console.log("세션 스토리지 데이터:",c),!c){alert("주문할 상품을 선택해주세요."),window.location.href="/cart";return}const t=JSON.parse(c);console.log("파싱된 상품 데이터:",t);const r={name:"홍길동",phone:"010-1234-5678",email:"hong@example.com"};a({orderItems:t}),d(r)}catch(c){console.error("주문 데이터 조회 실패:",c),i("주문 정보를 불러올 수 없습니다")}},M=async c=>{try{l(!0);const t=await O.createOrder({...c,totalAmount:C(c.items)});t&&t.success?await E(t.orderId,c.paymentMethod):alert(t?.message||"주문 생성에 실패했습니다")}catch(t){console.error("주문 생성 실패:",t),alert("주문 처리 중 오류가 발생했습니다")}finally{l(!1)}},E=async(c,t)=>{try{l(!0);const r=C(s.items),x=await O.processPayment({orderId:c,paymentMethod:t,amount:r});x&&x.success?(alert("결제가 완료되었습니다!"),sessionStorage.removeItem("selectedCartItems"),window.location.href=`/order/complete/${c}`):alert(x?.message||"결제에 실패했습니다")}catch(r){console.error("결제 처리 실패:",r),alert("결제 처리 중 오류가 발생했습니다")}finally{l(!1)}},C=c=>c.reduce((t,r)=>t+r.price*r.quantity,0),R=c=>{n(c)},L=async c=>{try{f(!0),l(!0),await new Promise(t=>setTimeout(t,1500)),alert("결제 처리가 완료되었습니다!")}catch(t){console.error("임시 결제 처리 실패:",t),alert("임시 결제 처리 중 오류가 발생했습니다")}finally{f(!1),l(!1)}},$=async()=>{if(!y){alert("결제 수단을 먼저 선택해주세요.");return}console.log("=== 결제 시작 ==="),console.log("paymentMethod:",y),console.log("items:",u),console.log("memberInfo:",o);try{l(!0),console.log("주문 데이터:",{cartItemIds:u.map(r=>r.cartItemId),items:u.map(r=>({cartItemId:r.cartItemId,productId:r.productId,price:r.price,quantity:r.quantity,total:r.price*r.quantity})),totalAmount:w}),console.log("각 아이템의 cartItemId 상세:"),u.forEach((r,x)=>{console.log(`아이템 ${x}:`,{cartItemId:r.cartItemId,productId:r.productId,productName:r.productName,전체객체:r})});const c={cartItemIds:u.map(r=>r.cartItemId),ordererName:o.name||"",phone:o.phone||"",email:o.email||"",requirements:o.requirements||"",paymentMethod:y,totalAmount:w};console.log("POST 요청 전송:",c),console.log("요청 URL:","/order/create"),console.log("요청 메서드:","POST");const t=await fetch("/order/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)});if(console.log("응답 상태:",t.status,t.statusText),console.log("응답 헤더:",Object.fromEntries(t.headers.entries())),console.log("응답 URL:",t.url),console.log("요청이 리다이렉트되었나?:",t.redirected),t.ok){const r=await t.json();console.log("결제 성공 응답:",r),k(!0),setTimeout(()=>{console.log("=== 리다이렉트 시작 ==="),console.log("result 전체:",r),console.log("result.data:",r.data),console.log("orderCode:",r.data?.orderCode),sessionStorage.removeItem("selectedCartItems"),window.updateCartCount&&window.updateCartCount();const x=r.orderCode||r.data?.orderCode;if(x){const P=`/order/complete?orderCode=${x}`;console.log("리다이렉트 URL:",P),console.log("리다이렉트 실행 중..."),window.location.href=P}else console.error("orderCode가 없습니다!"),console.error("result 구조:",r),alert("주문 코드를 찾을 수 없습니다. 주문내역에서 확인해주세요."),window.location.href="/mypage/orders"},2e3)}else{console.error("결제 실패 응답:",t.status,t.statusText);const r=await t.text();console.error("에러 내용:",r),alert(`결제에 실패했습니다: ${t.status} ${t.statusText}`)}}catch(c){console.error("결제 처리 실패:",c),alert("결제 처리 중 오류가 발생했습니다")}finally{l(!1)}};return m?e.jsx("div",{className:"order-container",children:e.jsx(F,{message:m,onRetry:S})}):s?e.jsxs("div",{className:"order-container",children:[e.jsx("div",{className:"continue-shopping-section",children:e.jsx("a",{href:"/cart",className:"continue-shopping-btn",children:"< 장바구니로 이동"})}),e.jsxs("div",{className:"order-layout",children:[e.jsx("div",{className:"order-content",children:e.jsx(U,{orderItems:u,memberInfo:o,onSubmit:M,loading:p,onPaymentMethodChange:R,paymentMethod:y})}),e.jsx("div",{className:"order-sidebar",children:e.jsx(B,{items:u})})]}),e.jsxs("div",{className:"order-notice",children:[e.jsx("div",{className:"notice-item",children:"※ 관광 상품은 예약 확정 후 취소 불가능합니다."}),e.jsx("div",{className:"notice-item",children:"※ 날씨나 현지 사정으로 인한 변경 시 사전안내 드립니다."}),e.jsx("div",{className:"notice-item",children:"※ 결제 후 예약 확정 안내를 받으실 수 있습니다."})]}),e.jsx("div",{className:"order-bottom",children:e.jsxs("button",{onClick:$,className:"full-payment-button",disabled:!u.length,children:[w?.toLocaleString(),"원 결제하기"]})}),T&&e.jsx("div",{className:"modal-overlay",onClick:()=>v(!1),children:e.jsxs("div",{className:"modal-content",onClick:c=>c.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"알림"}),e.jsx("button",{className:"modal-close",onClick:()=>v(!1),children:"×"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("p",{children:["회원 정보가 자동으로 입력됩니다.",e.jsx("br",{}),"(회원 정보는 마이페이지 > 회원 정보 관리에서 수정 가능합니다.)"]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"modal-confirm-btn",onClick:()=>v(!1),children:"확인"})})]})}),q&&e.jsx("div",{className:"modal-overlay",children:e.jsx("div",{className:"loading-modal-content",children:e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"loading-spinner",children:e.jsx("i",{className:"fas fa-spinner fa-spin"})}),e.jsxs("div",{className:"loading-text",children:["결제 처리가 완료되었습니다.",e.jsx("br",{}),"주문 완료 페이지로 이동합니다..."]})]})})})]}):e.jsxs("div",{className:"order-container",children:[e.jsx("div",{className:"continue-shopping-section",children:e.jsx("a",{href:"/cart",className:"continue-shopping-btn",children:"< 장바구니로 이동"})}),e.jsx("p",{children:"주문 정보를 불러오는 중..."})]})}D.createRoot(document.getElementById("order-root")).render(e.jsx(J.StrictMode,{children:e.jsx(G,{})}));
