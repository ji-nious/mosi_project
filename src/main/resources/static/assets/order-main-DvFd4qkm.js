import{r as u,j as e,R as G,a as B}from"./client-D_PkVYew.js";import"./modulepreload-polyfill-B5Qt9EMX.js";const v=async a=>{if(a.status===401)return window.location.href="/login",null;try{const s=await a.json();if(s.header&&s.header.rtcd!=="S00")throw new Error(s.header.rtmsg||"요청 처리 중 오류가 발생했습니다");return s.body||s}catch(s){throw s.message!=="서버 응답을 처리할 수 없습니다"?s:(console.error("JSON 파싱 오류:",s),new Error("서버 응답을 처리할 수 없습니다"))}},g=(a,s)=>{throw console.error(`${s} 실패:`,a),a},k={async getOrderInfo(){try{const a=await fetch("/order/info",{method:"GET",headers:{"Content-Type":"application/json"}});return await v(a)}catch(a){g(a,"주문 정보 조회")}},async createOrder(a){try{const s=await fetch("/order/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return await v(s)}catch(s){g(s,"주문 생성")}},async processPayment(a){try{const s=await fetch("/order/payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(a)});return await v(s)}catch(s){g(s,"결제 처리")}},async getOrderDetail(a){try{const s=await fetch(`/order/${a}`,{method:"GET",headers:{"Content-Type":"application/json"}});return await v(s)}catch(s){g(s,"주문 상세 조회")}},async cancelOrder(a,s){try{const i=await fetch(`/order/${a}/cancel`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({reason:s})});return await v(i)}catch(i){g(i,"주문 취소")}}};function C({name:a,value:s,checked:i,onChange:m,children:l}){return e.jsxs("div",{className:`payment-option ${i?"selected":""}`,onClick:()=>m(s),children:[e.jsx("input",{type:"radio",name:a,value:s,checked:i,onChange:()=>m(s),className:"payment-radio"}),e.jsx("div",{className:"payment-content",children:e.jsx("div",{className:"payment-label",children:l})})]})}function F({productName:a,price:s,quantity:i,optionType:m,sellerNickname:l,productImage:c,originalPrice:d}){return console.log("🖼️ OrderItem 이미지 데이터:",a,"→",c?"Base64 있음":"null/undefined"),e.jsxs("div",{className:"order-item",children:[e.jsxs("div",{className:"order-item-image",children:[c?e.jsx("img",{src:c,alt:a,loading:"lazy",onError:p=>{console.log("❌ 이미지 로드 실패:",a,"→",c),p.target.style.display="none",p.target.nextSibling.style.display="block"}}):e.jsx("div",{className:"no-image",children:"이미지 없음"}),e.jsx("div",{className:"no-image",style:{display:"none"},children:"이미지 없음"})]}),e.jsxs("div",{className:"order-item-info",children:[e.jsx("div",{className:"order-item-title",children:a}),e.jsxs("div",{className:"order-item-option",children:["옵션: ",m]}),e.jsxs("div",{className:"order-item-seller",children:["판매자: ",l||"판매자"]})]}),e.jsxs("div",{className:"order-item-price",children:[d&&d!==s&&e.jsxs("span",{className:"original-price",children:[(d*i).toLocaleString(),"원"]}),e.jsxs("span",{className:"sale-price",children:[(s*i).toLocaleString(),"원"]})]})]})}function z({orderItems:a=[],memberInfo:s={},onSubmit:i,paymentMethod:m,onPaymentMethodChange:l,onRequirementsChange:c}){const[d,p]=u.useState({ordererName:s.name||"",phone:s.phone||"",email:s.email||"",requirements:""}),y=(n,x)=>{p(b=>({...b,[n]:x})),c&&c(x)},S=n=>{if(n.preventDefault(),!d.ordererName||!d.phone||!d.email){alert("필수 정보를 모두 입력해주세요.");return}if(!m){alert("결제수단을 선택해주세요.");return}i({...d,items:a})};return e.jsxs("form",{onSubmit:S,className:"order-form",children:[e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("i",{className:"fas fa-user section-icon"}),"주문자 정보"]}),e.jsxs("div",{className:"form-section-content",children:[e.jsx("div",{className:"order-info-item",children:e.jsxs("div",{className:"order-info-content",children:[e.jsx("div",{className:"order-info-label",children:"주문자명"}),e.jsx("div",{className:"order-info-value",children:d.ordererName||"정보 없음"})]})}),e.jsx("div",{className:"order-info-item",children:e.jsxs("div",{className:"order-info-content",children:[e.jsx("div",{className:"order-info-label",children:"연락처"}),e.jsx("div",{className:"order-info-value",children:d.phone||"정보 없음"})]})}),e.jsx("div",{className:"order-info-item",children:e.jsxs("div",{className:"order-info-content",children:[e.jsx("div",{className:"order-info-label",children:"이메일"}),e.jsx("div",{className:"order-info-value",children:d.email||"정보 없음"})]})}),e.jsx("div",{className:"order-info-item",children:e.jsxs("div",{className:"order-info-content",children:[e.jsx("div",{className:"order-info-label",children:"요청사항"}),e.jsxs("div",{className:"order-info-value",children:[e.jsx("textarea",{placeholder:"요청사항을 입력해주세요(50자 이내)",value:d.requirements,onChange:n=>y("requirements",n.target.value),className:"form-textarea requirements-textarea",rows:"2",maxLength:50}),e.jsxs("div",{className:"character-counter",children:[e.jsxs("span",{className:d.requirements.length>50?"error":"",children:[d.requirements.length,"/50자"]}),d.requirements.length>50&&e.jsx("span",{className:"error-message",children:"50자를 초과했습니다."})]})]})]})})]})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("i",{className:"fas fa-credit-card section-icon"}),"결제수단"]}),e.jsx("div",{className:"form-section-content",children:e.jsxs("div",{className:"payment-options",children:[e.jsx(C,{name:"payment",value:"card",checked:m==="card",onChange:n=>{l(n),window.processPaymentImmediately&&window.processPaymentImmediately(n)},children:"신용카드 / 체크카드"}),e.jsx(C,{name:"payment",value:"bank",checked:m==="bank",onChange:n=>{l(n),window.processPaymentImmediately&&window.processPaymentImmediately(n)},children:"무통장입금"}),e.jsx(C,{name:"payment",value:"simple",checked:m==="simple",onChange:n=>{l(n),window.processPaymentImmediately&&window.processPaymentImmediately(n)},children:"간편결제"})]})})]}),e.jsxs("div",{className:"form-section",children:[e.jsxs("div",{className:"section-title",children:[e.jsx("i",{className:"fas fa-shopping-bag section-icon"}),"주문상품(",a.length,"개)"]}),e.jsx("div",{className:"form-section-content",children:a.length>0?a.map((n,x)=>e.jsx(F,{productName:n.productName,price:n.price,quantity:n.quantity,optionType:n.optionType,sellerNickname:n.sellerNickname,productImage:n.productImage,originalPrice:n.originalPrice},x)):e.jsxs("div",{className:"no-items",children:[e.jsx("p",{children:"주문할 상품이 없습니다."}),e.jsx("a",{href:"/cart",className:"go-cart-btn",children:"장바구니로 이동"})]})})]})]})}function H({items:a=[]}){a.length;const s=a.reduce((l,c)=>l+(c.originalPrice||c.price)*c.quantity,0),i=a.reduce((l,c)=>l+c.price*c.quantity,0),m=s-i;return e.jsxs("div",{className:"payment-summary",children:[e.jsx("div",{className:"payment-title",children:"결제정보"}),e.jsxs("div",{className:"order-summary-section",children:[e.jsx("div",{className:"summary-header",children:e.jsx("span",{children:"주문상품"})}),e.jsx("div",{className:"items-summary",children:a.map((l,c)=>e.jsxs("div",{className:"summary-item",children:[e.jsx("span",{className:"item-name",children:l.productName}),e.jsxs("span",{className:"item-price",children:[(l.price*l.quantity).toLocaleString(),"원"]})]},c))})]}),e.jsxs("div",{className:"payment-details",children:[e.jsxs("div",{className:"payment-row",children:[e.jsx("span",{children:"상품금액"}),e.jsxs("span",{children:[s?.toLocaleString(),"원"]})]}),m>0&&e.jsxs("div",{className:"payment-row discount",children:[e.jsx("span",{children:"할인금액"}),e.jsxs("span",{className:"discount-amount",children:["-",m?.toLocaleString(),"원"]})]})]}),e.jsxs("div",{className:"payment-total",children:[e.jsx("span",{className:"payment-total-label",children:"총 결제 금액"}),e.jsxs("span",{className:"payment-total-price",children:[i?.toLocaleString(),"원"]})]})]})}function K({message:a,onRetry:s}){return e.jsxs("div",{className:"error-container",children:[e.jsx("div",{className:"error-icon",children:e.jsx("i",{className:"fas fa-exclamation-triangle"})}),e.jsx("h2",{children:"오류가 발생했습니다"}),e.jsx("p",{children:a}),e.jsx("button",{onClick:s,className:"payment-button",children:"다시 시도"})]})}function Q(){const[a,s]=u.useState(null),[i,m]=u.useState({}),[l,c]=u.useState(null),[d,p]=u.useState(!1),[y,S]=u.useState(""),[n,x]=u.useState(!1),[b,w]=u.useState(!1),[q,R]=u.useState(!1),[E,M]=u.useState(""),f=a?.orderItems||[],I=f.reduce((o,r)=>o+r.price*r.quantity,0);u.useEffect(()=>(P(),window.processPaymentImmediately=L,w(!0),()=>{delete window.processPaymentImmediately}),[]);const P=async()=>{try{c(null);let o=sessionStorage.getItem("selectedCartItems"),r=null;if(o)r=JSON.parse(o);else try{const t=await fetch("/order/session-state",{method:"GET",credentials:"include"});if(t.ok){const h=await t.json(),j=h.body||h;if(j.cartItemIds&&j.cartItemIds.length>0){const N=await fetch(`/cart/items?ids=${j.cartItemIds.join(",")}`,{method:"GET",credentials:"include"});if(N.ok){const T=await N.json();r=T.body||T,sessionStorage.setItem("selectedCartItems",JSON.stringify(r))}}}}catch(t){console.log("서버 세션 상태 복원 실패:",t)}if(!r||r.length===0){alert("주문할 상품을 선택해주세요."),window.location.href="/cart";return}try{const t=await fetch("/order/member-info",{method:"GET",credentials:"include"});if(t.ok){const h=await t.json(),j=h.body||h;m({name:j.name||"",phone:j.tel||"",email:j.email||""})}else m({name:"",phone:"",email:""})}catch{m({name:"",phone:"",email:""})}s({orderItems:r})}catch{c("주문 정보를 불러올 수 없습니다")}},D=async o=>{try{p(!0);const r=await k.createOrder({...o,totalAmount:O(o.items)});r&&r.success?await $(r.orderId,o.paymentMethod):alert(r?.message||"주문 생성에 실패했습니다")}catch(r){console.error("주문 생성 실패:",r),alert("주문 처리 중 오류가 발생했습니다")}finally{p(!1)}},$=async(o,r)=>{try{p(!0);const t=O(a.items),h=await k.processPayment({orderId:o,paymentMethod:r,amount:t});h&&h.success?(alert("결제가 완료되었습니다!"),sessionStorage.removeItem("selectedCartItems"),window.location.href=`/order/complete/${o}`):alert(h?.message||"결제에 실패했습니다")}catch(t){console.error("결제 처리 실패:",t),alert("결제 처리 중 오류가 발생했습니다")}finally{p(!1)}},O=o=>o.reduce((r,t)=>r+t.price*t.quantity,0),J=o=>{S(o)},L=async o=>{try{x(!0),p(!0),await new Promise(r=>setTimeout(r,1500)),alert("결제가 완료되었습니다.")}catch(r){console.error("임시 결제 처리 실패:",r),alert("임시 결제 처리 중 오류가 발생했습니다")}finally{x(!1),p(!1)}},A=async()=>{if(!y){alert("결제 수단을 먼저 선택해주세요.");return}try{p(!0);const o={cartItemIds:f.map(t=>t.cartItemId),ordererName:i.name||"",phone:i.phone||"",email:i.email||"",requirements:E||"",paymentMethod:y,totalAmount:I},r=await fetch("/order/create",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(o)});if(r.ok){const t=await r.json();if(t.header&&t.header.rtcd!=="S00")throw new Error(t.header.rtmsg||"주문 처리 중 오류가 발생했습니다.");const h=t.body||t,j=h.orderCode||h.data?.orderCode;j&&await fetch("/order/payment",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({orderCode:j,paymentMethod:y})}),R(!0),setTimeout(()=>{sessionStorage.removeItem("selectedCartItems"),window.updateCartCount&&window.updateCartCount();const N=h.orderCode||h.data?.orderCode;N?window.location.href=`/order/complete?orderCode=${N}`:(alert("주문 코드를 찾을 수 없습니다. 주문내역에서 확인해주세요."),window.location.href="/mypage/orders")},2e3)}else{const t=await r.json().catch(()=>({})),h=t.header?.rtmsg||t.message||`결제에 실패했습니다: ${r.status} ${r.statusText}`;alert(h)}}catch{alert("주문 처리 중 오류가 발생했습니다. 다시 시도해주세요.")}finally{p(!1)}};return l?e.jsx("div",{className:"order-container",children:e.jsx(K,{message:l,onRetry:P})}):a?e.jsxs("div",{className:"order-container",children:[e.jsx("div",{className:"continue-shopping-section",children:e.jsx("a",{href:"/cart",className:"continue-shopping-btn",children:"< 장바구니로 이동"})}),e.jsxs("div",{className:"order-layout",children:[e.jsx("div",{className:"order-content",children:e.jsx(z,{orderItems:f,memberInfo:i,onSubmit:D,loading:d,onPaymentMethodChange:J,paymentMethod:y,onRequirementsChange:M})}),e.jsx("div",{className:"order-sidebar",children:e.jsx(H,{items:f})})]}),e.jsxs("div",{className:"order-notice",children:[e.jsx("div",{className:"notice-item",children:"※ 관광 상품은 예약 확정 후 취소 불가능합니다."}),e.jsx("div",{className:"notice-item",children:"※ 날씨나 현지 사정으로 인한 변경 시 사전안내 드립니다."}),e.jsx("div",{className:"notice-item",children:"※ 결제 후 예약 확정 안내를 받으실 수 있습니다."})]}),e.jsx("div",{className:"order-bottom",children:e.jsxs("button",{onClick:A,className:"full-payment-button",disabled:!f.length,children:[I?.toLocaleString(),"원 결제하기"]})}),b&&e.jsx("div",{className:"modal-overlay",onClick:()=>w(!1),children:e.jsxs("div",{className:"modal-content",onClick:o=>o.stopPropagation(),children:[e.jsxs("div",{className:"modal-header",children:[e.jsx("h3",{children:"알림"}),e.jsx("button",{className:"modal-close",onClick:()=>w(!1),children:"×"})]}),e.jsx("div",{className:"modal-body",children:e.jsxs("p",{children:["회원 정보가 자동으로 입력됩니다.",e.jsx("br",{}),"(회원 정보 수정은 내 정보>회원 정보 관리에서 가능)"]})}),e.jsx("div",{className:"modal-footer",children:e.jsx("button",{className:"modal-confirm-btn",onClick:()=>w(!1),children:"확인"})})]})}),q&&e.jsx("div",{className:"modal-overlay",children:e.jsx("div",{className:"loading-modal-content",children:e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"custom-spinner"}),e.jsxs("div",{className:"loading-text",children:["주문 처리 중입니다.",e.jsx("br",{}),"잠시만 기다려 주세요."]})]})})})]}):e.jsxs("div",{className:"order-container",children:[e.jsx("div",{className:"continue-shopping-section",children:e.jsx("a",{href:"/cart",className:"continue-shopping-btn",children:"< 장바구니로 이동"})}),e.jsx("p",{children:"주문 정보를 불러오는 중..."})]})}G.createRoot(document.getElementById("order-root")).render(e.jsx(B.StrictMode,{children:e.jsx(Q,{})}));
