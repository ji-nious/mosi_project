import{r as i,j as e,R,a as A}from"./client-D_PkVYew.js";import"./modulepreload-polyfill-B5Qt9EMX.js";const k=async a=>{if(a.status===401)return window.location.href="/login",null;if(!a.ok){const r=await a.json().catch(()=>({})),n=r.header?.rtmsg||r.message||`HTTP ${a.status}: ${a.statusText}`;throw new Error(n)}try{const r=await a.json();if(r.header&&r.header.rtcd!=="S00")throw new Error(r.header.rtmsg||"요청 처리 중 오류가 발생했습니다");return r.body||r}catch(r){throw r.message!=="서버 응답을 처리할 수 없습니다"?r:new Error("서버 응답을 처리할 수 없습니다")}},C={async getCart(){try{const a=await fetch("/cart",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});if(a.status===401)return window.location.href="/login",null;if(!a.ok){const n=await a.json().catch(()=>({})),o=n.header?.rtmsg||n.message||`HTTP ${a.status}: ${a.statusText}`;throw new Error(o)}const r=await a.json();if(r.header&&r.header.rtcd!=="S00")throw new Error(r.header.rtmsg||"요청 처리 중 오류가 발생했습니다");return r.body||r}catch(a){throw console.error("장바구니 조회 실패:",a),a}},async updateQuantity(a,r,n){try{const o=await fetch("/cart/quantity",{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({productId:a,optionType:r,quantity:n})});return await k(o)}catch(o){throw console.error("수량 변경 실패:",o),o}},async removeFromCart(a,r){try{const n=await fetch("/cart/remove",{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({productId:a,optionType:r})});return await k(n)}catch(n){throw console.error("상품 삭제 실패:",n),n}},async addToCart(a,r,n){try{const o=document.querySelector('meta[name="_csrf"]')?.getAttribute("content"),l=document.querySelector('meta[name="_csrf_header"]')?.getAttribute("content"),d={"Content-Type":"application/json",Accept:"application/json"};o&&l&&(d[l]=o);const m=await fetch("/cart/add",{method:"POST",headers:d,credentials:"include",body:JSON.stringify({productId:parseInt(a),optionType:r,quantity:parseInt(n)})});return await k(m)}catch(o){throw console.error("장바구니 추가 실패:",o),o}}},D=i.memo(({item:a,selected:r,onSelect:n,onQuantityChange:o,onRemove:l,updating:d=!1})=>{const[m,p]=i.useState(!1);i.useCallback(async s=>{if(!(s<1||m||d)){p(!0);try{await o(a.productId,a.optionType,s)}catch(h){console.error("수량 변경 실패:",h),alert("수량 변경에 실패했습니다")}finally{p(!1)}}},[a.productId,a.optionType,o,m,d]);const I=i.useCallback(async()=>{if(!(m||d)&&confirm("해당 상품을 삭제하시겠습니까?")){p(!0);try{await l(a.productId,a.optionType)}catch(s){console.error("삭제 실패:",s),alert("삭제에 실패했습니다")}finally{p(!1)}}},[a.productId,a.optionType,l,m,d]),g=i.useCallback(s=>{n(a.productId,a.optionType,s)},[a.productId,a.optionType,n]),{productName:u,description:E,price:w,originalPrice:j,quantity:S,optionType:T,productImage:N,sellerNickname:x,available:y=!0}=a,f=w*S,v=j&&j>w,t=m||d||!y,c=m||d;return e.jsxs("div",{className:`cart-item ${r?"selected":""} ${m?"updating":""} ${y?"":"unavailable"}`,children:[e.jsx("input",{type:"checkbox",checked:r,onChange:s=>g(s.target.checked),disabled:t,className:"item-checkbox"}),e.jsxs("div",{className:"item-image",children:[N?e.jsx("img",{src:N,alt:u,loading:"lazy",onError:s=>{s.target&&(s.target.style.display="none",s.target.nextSibling&&(s.target.nextSibling.style.display="block"))}}):e.jsx("div",{className:"no-image",children:"이미지 없음"}),!y&&e.jsx("div",{className:"sold-out-status",children:"품절"})]}),e.jsxs("div",{className:"item-info",children:[e.jsx("div",{className:"item-title",children:u}),e.jsxs("div",{className:"item-seller",children:["판매자: ",x||"판매자"]}),e.jsxs("div",{className:"item-option",children:["옵션: ",T]})]}),e.jsxs("div",{className:"item-price-info",children:[v&&e.jsxs("div",{className:"item-original-price",children:[j?.toLocaleString(),"원"]}),e.jsxs("div",{className:"item-price",children:[f?.toLocaleString(),"원"]})]}),e.jsx("button",{onClick:I,disabled:c,className:"remove-btn",title:"삭제",type:"button",children:m?e.jsx("div",{className:"button-spinner"}):e.jsx("i",{className:"fas fa-times"})})]})});D.displayName="CartItem";function q(){const[a,r]=i.useState(null),[n,o]=i.useState(null),[l,d]=i.useState(new Set),[m,p]=i.useState(!1),[I,g]=i.useState(!0);i.useEffect(()=>{u()},[]);const u=i.useCallback(async()=>{try{o(null),g(!0),console.log("🛒 장바구니 데이터 요청 시작...");const t=await C.getCart();if(console.log("📦 장바구니 응답 데이터:",t),t&&t.success)if(console.log("✅ 장바구니 데이터 성공:",t),r(t),t.cartItems&&t.cartItems.length>0){const c=t.cartItems.filter(s=>s.available).map(s=>`${s.productId}-${s.optionType}`);d(new Set(c))}else d(new Set);else console.log("❌ 장바구니 데이터 실패:",t),o("장바구니 데이터를 불러올 수 없습니다")}catch(t){console.log("🚨 장바구니 네트워크 오류:",t),o("네트워크 오류가 발생했습니다")}finally{g(!1)}},[]),E=i.useCallback(async(t,c,s)=>{try{p(!0);const h=await C.updateQuantity(t,c,s);h&&h.success?(await u(),window.updateCartCount&&await window.updateCartCount()):alert(h?.message||"수량 변경에 실패했습니다")}catch{alert("수량 변경 중 오류가 발생했습니다")}finally{p(!1)}},[u]),w=i.useCallback(async(t,c)=>{try{p(!0);const s=await C.removeFromCart(t,c);s&&s.success?(await u(),d(h=>{const b=new Set(h);return b.delete(`${t}-${c}`),b}),window.updateCartCount&&await window.updateCartCount()):alert(s?.message||"삭제에 실패했습니다")}catch{alert("삭제 중 오류가 발생했습니다")}finally{p(!1)}},[u]),j=i.useCallback((t,c,s)=>{const h=`${t}-${c}`;d(b=>{const $=new Set(b);return s?$.add(h):$.delete(h),$})},[]),S=i.useCallback(t=>{if(t){const c=a?.cartItems?.filter(s=>s.available).map(s=>`${s.productId}-${s.optionType}`)||[];d(new Set(c))}else d(new Set)},[a?.cartItems]),T=i.useCallback(async()=>{if(l.size===0){alert("삭제할 상품을 선택해주세요.");return}if(confirm(`${l.size}개 상품을 삭제하시겠습니까?`))try{p(!0);for(const t of l){const[c,s]=t.split("-");await C.removeFromCart(parseInt(c),s)}await u(),d(new Set),window.updateCartCount&&await window.updateCartCount(),alert(`${l.size}개 상품이 삭제되었습니다.`)}catch{alert("삭제 중 오류가 발생했습니다")}finally{p(!1)}},[l,u]),N=i.useCallback(async()=>{const t=a?.cartItems?.filter(c=>c.available&&l.has(`${c.productId}-${c.optionType}`))||[];if(t.length===0){alert("주문할 상품을 선택해주세요");return}try{sessionStorage.setItem("selectedCartItems",JSON.stringify(t)),window.location.href="/order"}catch{alert("주문 생성 중 오류가 발생했습니다")}},[a?.cartItems,l]),x=a?.cartItems||[],y=x.filter(t=>t.available),f=x.filter(t=>t.available&&l.has(`${t.productId}-${t.optionType}`)),v=y.length>0&&l.size===y.length;return I?e.jsx("div",{className:"react-cart-content",children:e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"custom-spinner"}),e.jsx("div",{className:"loading-text",children:"장바구니를 불러오는 중..."})]})}):n?e.jsx("div",{className:"cart-container",children:e.jsxs("div",{className:"error-container",children:[e.jsx("div",{className:"error-icon",children:e.jsx("i",{className:"fas fa-exclamation-triangle"})}),e.jsx("h2",{children:"오류가 발생했습니다"}),e.jsx("p",{children:n}),e.jsx("button",{onClick:u,className:"order-button",children:"다시 시도"})]})}):a?.empty?e.jsxs("div",{className:"empty-cart-content",children:[e.jsx("div",{className:"empty-cart-icon",children:e.jsx("i",{className:"fas fa-shopping-cart cart-icon"})}),e.jsx("div",{className:"empty-cart-title",children:"장바구니가 비어 있습니다"}),e.jsx("a",{href:"/product/list",className:"shop-button",children:"쇼핑하러 가기"})]}):e.jsxs("div",{className:"react-cart-content",children:[e.jsx("div",{className:"continue-shopping-section",children:e.jsx("a",{href:"/product/list",className:"continue-shopping-btn",children:"< 계속 쇼핑하기"})}),e.jsxs("div",{className:`select-all-section ${v?"":"unselected"}`,children:[e.jsxs("div",{className:"left",children:[e.jsx("input",{type:"checkbox",checked:v,onChange:t=>S(t.target.checked),className:"custom-checkbox"}),e.jsxs("span",{className:"select-all-text",children:["전체선택(",l.size,"/",y.length,")"]})]}),e.jsx("div",{className:"select-actions",children:e.jsx("button",{onClick:T,disabled:l.size===0||m,className:"delete-selected-btn",children:"선택삭제"})})]}),x.map(t=>e.jsx(D,{item:t,selected:l.has(`${t.productId}-${t.optionType}`),onSelect:j,onQuantityChange:E,onRemove:w,updating:m},`${t.productId}-${t.optionType}`)),e.jsxs("div",{className:"order-summary",children:[e.jsxs("div",{className:"summary-title",children:[e.jsx("i",{className:"fas fa-file-alt"}),"주문요약"]}),e.jsx("div",{className:"summary-section",children:e.jsxs("div",{className:"summary-label",children:["선택된 상품",e.jsxs("span",{className:"selected-count",children:[f.length,"개"]})]})}),e.jsx("div",{className:"price-list",children:f.map(t=>e.jsxs("div",{className:"price-item",children:[e.jsxs("div",{className:"price-item-info",children:[e.jsx("div",{className:"price-item-name",children:t.productName}),e.jsx("div",{className:"price-item-type",children:t.optionType})]}),e.jsxs("span",{className:"price-item-amount",children:[(t.price*t.quantity).toLocaleString(),"원"]})]},`item-${t.productId}-${t.optionType}`))}),e.jsxs("div",{className:"total-amount",children:[e.jsx("span",{className:"total-label",children:"총 결제 금액"}),e.jsxs("span",{className:"total-price",children:[f.reduce((t,c)=>t+c.price*c.quantity,0)?.toLocaleString(),"원"]})]}),e.jsx("div",{className:"download-notice",children:"※ 파일은 결제 후 7일간 다운로드 가능합니다."}),e.jsx("button",{onClick:N,className:"order-button",disabled:f.length===0||m,children:m?e.jsx("div",{className:"button-spinner"}):`${f.length}개 상품 주문하기`})]})]})}R.createRoot(document.getElementById("cart-root")).render(e.jsx(A.StrictMode,{children:e.jsx(q,{})}));
