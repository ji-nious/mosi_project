import{r,j as e,R as z,a as R}from"./client-DJIKB08a.js";const T=async a=>{if(a.status===401)return window.location.href="/login",null;if(!a.ok){const d=await a.json().catch(()=>({}));throw new Error(d.message||`HTTP ${a.status}: ${a.statusText}`)}try{return await a.json()}catch{throw new Error("서버 응답을 처리할 수 없습니다")}},C={async getCart(){try{const a=await fetch("/cart",{method:"GET",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include"});return await T(a)}catch(a){throw console.error("장바구니 조회 실패:",a),a}},async updateQuantity(a,d,i){try{const p=await fetch("/cart/quantity",{method:"PUT",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({productId:a,optionType:d,quantity:i})});return await T(p)}catch(p){throw console.error("수량 변경 실패:",p),p}},async removeFromCart(a,d){try{const i=await fetch("/cart/remove",{method:"DELETE",headers:{"Content-Type":"application/json",Accept:"application/json"},credentials:"include",body:JSON.stringify({productId:a,optionType:d})});return await T(i)}catch(i){throw console.error("상품 삭제 실패:",i),i}}},D=r.memo(({item:a,selected:d,onSelect:i,onQuantityChange:p,onRemove:n,updating:l=!1})=>{const[o,m]=r.useState(!1);r.useCallback(async s=>{if(!(s<1||o||l)){m(!0);try{await p(a.productId,a.optionType,s)}catch(c){console.error("수량 변경 실패:",c),alert("수량 변경에 실패했습니다")}finally{m(!1)}}},[a.productId,a.optionType,p,o,l]);const b=r.useCallback(async()=>{if(!(o||l)&&confirm("해당 상품을 삭제하시겠습니까?")){m(!0);try{await n(a.productId,a.optionType)}catch(s){console.error("삭제 실패:",s),alert("삭제에 실패했습니다")}finally{m(!1)}}},[a.productId,a.optionType,n,o,l]),N=r.useCallback(s=>{i(a.productId,a.optionType,s)},[a.productId,a.optionType,i]),{productName:u,description:E,price:g,originalPrice:x,quantity:I,optionType:S,productImage:w,sellerNickname:j,available:f=!0}=a,y=g*I,$=x&&x>g,t=o||l||!f;return e.jsxs("div",{className:`cart-item ${d?"selected":""} ${o?"updating":""} ${f?"":"unavailable"}`,children:[e.jsx("input",{type:"checkbox",checked:d,onChange:s=>N(s.target.checked),disabled:t,className:"item-checkbox"}),e.jsx("div",{className:"item-image",children:w?e.jsx("img",{src:w,alt:u,loading:"lazy",onError:s=>{s.target&&(s.target.style.display="none",s.target.nextSibling&&(s.target.nextSibling.style.display="block"))}}):e.jsx("div",{className:"no-image",children:"이미지 없음"})}),e.jsxs("div",{className:"item-info",children:[e.jsx("div",{className:"item-title",children:u}),!f&&e.jsx("div",{className:"sold-out-status",children:"판매중단"}),e.jsxs("div",{className:"item-option",children:["옵션: (",S,")"]}),e.jsxs("div",{className:"item-seller",children:["판매자: ",j||"판매자"]})]}),e.jsxs("div",{className:"item-price-info",children:[$&&e.jsxs("div",{className:"item-original-price",children:[x?.toLocaleString(),"원"]}),e.jsxs("div",{className:"item-price",children:[y?.toLocaleString(),"원"]})]}),e.jsx("button",{onClick:b,disabled:t,className:"remove-btn",title:"삭제",type:"button",children:o?e.jsx("i",{className:"fas fa-spinner fa-spin"}):e.jsx("i",{className:"fas fa-times"})})]})});D.displayName="CartItem";function L(){const[a,d]=r.useState(null),[i,p]=r.useState(null),[n,l]=r.useState(new Set),[o,m]=r.useState(!1),[b,N]=r.useState(!0);r.useEffect(()=>{u()},[]);const u=r.useCallback(async()=>{try{p(null),N(!0);const t=await C.getCart();if(t&&t.success)if(d(t),t.cartItems&&t.cartItems.length>0){const s=t.cartItems.map(c=>`${c.productId}-${c.optionType}`);l(new Set(s))}else l(new Set);else p("장바구니 데이터를 불러올 수 없습니다")}catch{p("네트워크 오류가 발생했습니다")}finally{N(!1)}},[]),E=r.useCallback(async(t,s,c)=>{try{m(!0);const h=await C.updateQuantity(t,s,c);h&&h.success?(await u(),window.updateCartCount&&await window.updateCartCount()):alert(h?.message||"수량 변경에 실패했습니다")}catch{alert("수량 변경 중 오류가 발생했습니다")}finally{m(!1)}},[u]),g=r.useCallback(async(t,s)=>{try{m(!0);const c=await C.removeFromCart(t,s);c&&c.success?(await u(),l(h=>{const v=new Set(h);return v.delete(`${t}-${s}`),v}),window.updateCartCount&&await window.updateCartCount()):alert(c?.message||"삭제에 실패했습니다")}catch{alert("삭제 중 오류가 발생했습니다")}finally{m(!1)}},[u]),x=r.useCallback((t,s,c)=>{const h=`${t}-${s}`;l(v=>{const k=new Set(v);return c?k.add(h):k.delete(h),k})},[]),I=r.useCallback(t=>{if(t){const s=a?.cartItems?.filter(c=>c.available).map(c=>`${c.productId}-${c.optionType}`)||[];l(new Set(s))}else l(new Set)},[a?.cartItems]),S=r.useCallback(async()=>{if(n.size===0){alert("삭제할 상품을 선택해주세요.");return}if(confirm(`${n.size}개 상품을 삭제하시겠습니까?`))try{m(!0);for(const t of n){const[s,c]=t.split("-");await C.removeFromCart(parseInt(s),c)}await u(),l(new Set),window.updateCartCount&&await window.updateCartCount(),alert(`${n.size}개 상품이 삭제되었습니다.`)}catch{alert("삭제 중 오류가 발생했습니다")}finally{m(!1)}},[n,u]),w=r.useCallback(async()=>{const t=a?.cartItems?.filter(s=>n.has(`${s.productId}-${s.optionType}`))||[];if(t.length===0){alert("주문할 상품을 선택해주세요");return}try{sessionStorage.setItem("selectedCartItems",JSON.stringify(t)),window.location.href="/order"}catch{alert("주문 생성 중 오류가 발생했습니다")}},[a?.cartItems,n]),j=a?.cartItems||[],f=j.filter(t=>t.available),y=j.filter(t=>n.has(`${t.productId}-${t.optionType}`)),$=f.length>0&&n.size===f.length;return b?e.jsx("div",{className:"react-cart-content",children:e.jsxs("div",{className:"loading-container",children:[e.jsx("div",{className:"loading-spinner",children:e.jsx("i",{className:"fas fa-spinner fa-spin"})}),e.jsx("div",{className:"loading-text",children:"장바구니를 불러오는 중..."})]})}):i?e.jsx("div",{className:"cart-container",children:e.jsxs("div",{className:"error-container",children:[e.jsx("div",{className:"error-icon",children:e.jsx("i",{className:"fas fa-exclamation-triangle"})}),e.jsx("h2",{children:"오류가 발생했습니다"}),e.jsx("p",{children:i}),e.jsx("button",{onClick:u,className:"order-button",children:"다시 시도"})]})}):a?.empty?e.jsxs("div",{className:"empty-cart-content",children:[e.jsx("div",{className:"empty-cart-icon",children:e.jsx("i",{className:"fas fa-shopping-cart cart-icon"})}),e.jsx("div",{className:"empty-cart-title",children:"장바구니가 비어 있습니다"}),e.jsx("a",{href:"/product/list",className:"shop-button",children:"쇼핑하러 가기"})]}):e.jsxs("div",{className:"react-cart-content",children:[e.jsx("div",{className:"continue-shopping-section",children:e.jsx("a",{href:"/product/list",className:"continue-shopping-btn",children:"< 계속 쇼핑하기"})}),e.jsxs("div",{className:"select-all-section",children:[e.jsxs("div",{className:"left",children:[e.jsx("input",{type:"checkbox",checked:$,onChange:t=>I(t.target.checked),className:"custom-checkbox"}),e.jsxs("span",{className:"select-all-text",children:["전체선택(",n.size,"/",f.length,")"]})]}),e.jsx("div",{className:"select-actions",children:e.jsx("button",{onClick:S,disabled:n.size===0||o,className:"delete-selected-btn",children:"선택삭제"})})]}),j.map(t=>e.jsx(D,{item:t,selected:n.has(`${t.productId}-${t.optionType}`),onSelect:x,onQuantityChange:E,onRemove:g,updating:o},`${t.productId}-${t.optionType}`)),e.jsxs("div",{className:"order-summary",children:[e.jsxs("div",{className:"summary-title",children:[e.jsx("i",{className:"fas fa-file-alt"}),"주문요약"]}),e.jsx("div",{className:"summary-section",children:e.jsxs("div",{className:"summary-label",children:["선택된 상품",e.jsxs("span",{className:"selected-count",children:[y.length,"개"]})]})}),e.jsx("div",{className:"price-list",children:y.map(t=>e.jsxs("div",{className:"price-item",children:[e.jsxs("div",{className:"price-item-info",children:[e.jsx("div",{className:"price-item-name",children:t.productName}),e.jsxs("div",{className:"price-item-type",children:["옵션: (",t.optionType,")"]})]}),e.jsxs("span",{className:"price-item-amount",children:[(t.price*t.quantity).toLocaleString(),"원"]})]},`item-${t.productId}-${t.optionType}`))}),e.jsxs("div",{className:"total-amount",children:[e.jsx("span",{className:"total-label",children:"총 결제 금액"}),e.jsxs("span",{className:"total-price",children:[y.reduce((t,s)=>t+s.price*s.quantity,0)?.toLocaleString(),"원"]})]}),e.jsx("div",{className:"download-notice",children:"※ 파일은 결제 후 7일간 다운로드 가능합니다."}),e.jsx("button",{onClick:w,className:"order-button",disabled:y.length===0||o,children:o?e.jsx("i",{className:"fas fa-spinner fa-spin"}):`${y.length}개 상품 주문하기`})]})]})}z.createRoot(document.getElementById("cart-root")).render(e.jsx(R.StrictMode,{children:e.jsx(L,{})}));
