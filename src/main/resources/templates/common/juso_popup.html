<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>주소 검색</title>
    <style>
        body { font-family: sans-serif; }
        .container { padding: 10px; }
        .form-group { margin-bottom: 10px; }
        input[type="text"] { width: 300px; padding: 5px; }
        button { padding: 5px 10px; }
        #list { margin-top: 10px; }
        table { border-collapse: collapse; width: 100%; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        tr:hover { background-color: #f5f5f5; cursor: pointer; }
    </style>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>
        function getAddr() {
            if (!checkSearchedWord(document.form.keyword)) {
                return;
            }
            $.ajax({
                url: "/api/address/search",
                type: "get",
                data: $("#form").serialize(),
                dataType: "json",
                success: function (jsonStr) {
                    var errCode = jsonStr.results.common.errorCode;
                    var errDesc = jsonStr.results.common.errorMessage;
                    if (errCode != "0") {
                        alert(errCode + "=" + errDesc);
                    } else {
                        if (jsonStr.results.juso.length > 0) {
                            makeListJson(jsonStr);
                        } else {
                            $("#list").html("검색 결과가 없습니다.");
                        }
                    }
                },
                error: function (xhr, status, error) {
                    alert("주소 검색 중 오류가 발생했습니다.");
                }
            });
        }

        function makeListJson(jsonStr) {
            let htmlStr = "<table><thead><tr><th>우편번호</th><th>도로명주소</th></tr></thead><tbody>";
            $(jsonStr.results.juso).each(function () {
                htmlStr += `<tr onclick="setParentAddr('${this.zipNo}', '${this.roadAddr}')">`;
                htmlStr += `<td>${this.zipNo}</td>`;
                htmlStr += `<td>${this.roadAddr}</td>`;
                htmlStr += "</tr>";
            });
            htmlStr += "</tbody></table>";
            $("#list").html(htmlStr);
        }

        function setParentAddr(zipNo, roadAddr) {
            if (opener) {
                $(opener.document).find("#postcode").val(zipNo);
                $(opener.document).find("#address").val(roadAddr);
                window.close();
            }
        }

        function checkSearchedWord(obj) {
            if (obj.value.trim().length === 0) {
                alert("검색어를 입력해주세요.");
                obj.focus();
                return false;
            }
            if (obj.value.length > 0) {
                var expText = /[%=><]/;
                if (expText.test(obj.value)) {
                    alert("특수문자를 입력할 수 없습니다.");
                    obj.value = obj.value.split(expText).join("");
                    return false;
                }
                var sqlArray = ["OR", "SELECT", "INSERT", "DELETE", "UPDATE", "CREATE", "DROP", "EXEC", "UNION", "FETCH", "DECLARE", "TRUNCATE"];
                var regex;
                for (var i = 0; i < sqlArray.length; i++) {
                    regex = new RegExp(sqlArray[i], "gi");
                    if (regex.test(obj.value)) {
                        alert(`"${sqlArray[i]}"와(과) 같은 특정문자로 검색할 수 없습니다.`);
                        obj.value = obj.value.replace(regex, "");
                        return false;
                    }
                }
            }
            return true;
        }

        function enterSearch(event) {
            if (event.keyCode === 13) {
                getAddr();
            }
        }

        $(document).ready(function() {
            $('#keyword').focus();
        });
    </script>
</head>
<body>
<div class="container">
    <h2>주소 검색</h2>
    <form name="form" id="form" method="post" onsubmit="return false;">
        <div class="form-group">
            <input type="hidden" name="currentPage" value="1"/>
            <input type="hidden" name="countPerPage" value="20"/>
            <input type="text" name="keyword" id="keyword" value="" onkeydown="enterSearch(event);" placeholder="도로명 또는 건물명을 입력하세요"/>
            <button type="button" onclick="getAddr();">검색</button>
        </div>
    </form>
    <div id="list"></div>
</div>
</body>
</html> 